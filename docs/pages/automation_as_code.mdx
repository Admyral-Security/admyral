import { FileTree } from "nextra/components";

# Automation-as-Code

Automation-as-Code is a way to create automations using Python code. Benefits include:

-   Being able to leverage Software Engineering best practices:
    -   Reduction of errors through automated testing when deploying an automation
    -   Version Control
    -   Pull requests (propose changes for review, encourage collaboration and discussion among team members, ensure good documentation)
-   Reduction in vendor lock-in as the automations are stored in plain Python code
-   Enabling to create custom actions, custom integrations with the flexibility of code
-   Easier reusability through a modularized setup of automations

## Project Structure

For compatability and increased reusability, the recommended project setup in Git should be as follows:

<FileTree>
	<FileTree.Folder name="your_project_name" defaultOpen>
		<FileTree.Folder name="actions" defaultOpen>
			<FileTree.File name="__init__.py" />
			<FileTree.File name="custom_action1.py" />
		</FileTree.Folder>
		<FileTree.Folder name="workflows" defaultOpen>
			<FileTree.File name="__init__.py" />
			<FileTree.File name="workflow1.py" />
		</FileTree.Folder>
	</FileTree.Folder>
</FileTree>

For an example, checkout our [Github example project](https://github.com/Admyral-Security/admyral-quickstart).

## The Workflow Function

The workflow function is a python function that is used to specify the control flow of the actions. Think of it like the receipt for the ingredients (pre-build actions, integrations, and custom actions).
It is specified with the `@workflow` decorator:

```bash
from admyral.workflow import workflow
from adymral.typings import JsonValue

@workflow
def example_workflow(dict: [str, JsonValue]):
    # some actions / control flow of your automation
```

When referring from one action to another, it is suggested to store the output from the previous action in a variable.

If an action returns

```bash
@workflow
def example_workflow():
    a = action1()
    b = action2(a)
```

This creates a dependency which is visualized accordingly in the No-Code Editor. (Action1 then Action2)

The workflow function is slightly restrictive as Admyral compiles it and maps it onto a [no-code interface](/no_code_editor). For example, as of now, for loops are not supported within the workflow function.
You would define a [custom action](/custom_actions) in which the for-loop is executed. The results can be used within the workflow function. This setup enables you to create a modular setup.

TODO: run_after
TODO: secrets
TODO: workflow decorator
TODO: Things which are not allowed =>
TODO: accessing data
TODO: list, dict, string formatting
TODO: for-loops coming soon

### Custom actions within in the workflow function

To facilitate a natural coding flow, Admyral supports custom actions within the workflow function. Each action has to be encapsulated by starting with `# {% custom %}` and `# {% endcustom %}`.

```bash
@workflow
def example_workflow():
    # some actions

    # {% custom %}
    # add custom python code here
    users = [a, b, c]
    for user in users:
        # do something
    # {% endcustom %}

    # continue your workflow function
```

Within the No-Code Editor, the `custom_action` will be displayed as a separate node. Read more about custom actions [here](/custom_actions).

### If-Conditions

Within the workflow function, it is allowed to use if-statements and nested if-statements. Admyral compiles these into an If-Condition node in the no-code editor.

```bash
@workflow
def example_workflow():
    # previous workflow logic with action A and B
    if result_from_action_a == true and result_from_action_b:
        # do something
```

TODO: if condition syntax => supported operators

## Executing an Automation

Automation based on Admyral is written in Python. This allows you to run and test your automations locally as standard Python scripts.

To execute an automation locally, simply call it like a normal Python function

```python
from admyral.workflow import workflow
from adymral.typings import JsonValue


@workflow
def example_workflow(dict: [str, JsonValue]):
    # some actions / control flow of your automation
    ...


if __name__ == "__main__":
    # just call your workflow function
    example_workflow({})

    # you can also pass a payload to your workflow as input
    example_workflow({
        "some_argument": ...
    })
```

and then simply execute it as a normal Python script:

```bash
python example_workflow.py
```

To execute an automation using Admyral's infrastructure, you first need to push the workflow (Note: by adding `--activate` your workflow is also immediately activated)
and then you can simply trigger it using the CLI:

```bash
# Push your workflow to Admyral
admyral workflow push example_workflow -f example_workflow.py --activate
# Trigger your workflow
admyral workflow trigger example_workflow
```
