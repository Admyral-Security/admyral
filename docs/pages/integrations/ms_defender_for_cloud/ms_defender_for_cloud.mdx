# Microsoft Defender for Cloud

## App Registration Connection

1. Go to your [Azure Portal](https://portal.azure.com/) and login.

2. Go to **Microsoft Entra ID**.

3. In the left menu, click on **App registrations**.

4. Click on **New registration**.

5. Name your app, e.g. `admyral-azure-integration` and click on **Register**.

6. Copy your **Client ID** and **Tenant ID**.

<img src="/ms_defender_for_cloud1.png" />

7. In the left menu, click on **Certificates & secrets** and then on **New client secret**.

8. Copy the **Value** of the secret.

9. In Azure, go to **Subscriptions** and copy the **Subscription ID** of the subscription you want to use.

10. In your subscrption, go to **Access Control (IAM)**. Click on **Add** and then **Add role assignment**.

<img src="/ms_defender_for_cloud2.png" />

11. Select the role **Security Reader** and click on **Next**.

<img src="/ms_defender_for_cloud3.png" />

12. Click **Select members** and search for the app you created in the first steps (e.g. `admyral-azure-integration`). Select it and then click on **Select**.

<img src="/ms_defender_for_cloud4.png" />

13. Click on **Review + assign**.

14. In your subscrption, go to **Access Control (IAM)**. Click on **Add** and then **Add custom role**.

<img src="/ms_defender_for_cloud5.png" />

15. Give the role a name, e.g. `Alert Handler`,

<img src="/ms_defender_for_cloud6.png" />

16. Go to the **Permissions** tab by clicking **Next**.

17. Click on **Add permissions** and type into the search bar `Microsoft.Security/locations/alerts/`. Check all the permissions.

<img src="/ms_defender_for_cloud7.png" />

18. Now, we need to assign the new role to the app. Go to **Access Control (IAM)** and click on **Add** and then **Add role assignment**.

19. Search for **Alert Handler** and select it.

<img src="/ms_defender_for_cloud8.png" />

20. Go to the **Members** tab next. Click on **Select members** and search for the app you created in the first steps (e.g. `admyral-azure-integration`). Select it and then click on **Select**.

21. Click on **Review + assign**.

22. Go to the **Settings** page in **Admyral**. Click on **Create New Secret** in the **Secrets** section.

23. Give your credential a name, e.g. `MS Defender`.

24. The following secrets structure is expected:

| Key             | Value                             |
| --------------- | --------------------------------- |
| `tenant_id`     | Paste your **Tenant ID** here     |
| `client_id`     | Paste your **Client ID** here     |
| `client_secret` | Paste your **Client Secret** here |

25. Click on the **Save** button.

Alternatively, you can use the following CLI command structure:

```bash
admyral secret set ms_defender_for_cloud_secret --value tenant_id=your_tenant_id --value client_id=your_client_id --value client_secret=your_client_secret
```
